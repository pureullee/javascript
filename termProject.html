<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <title>Document</title>
    <link rel="stylesheet" href="term.css">
</head>
<body>
    <!--PART1-->
    <h1 style="font-weight: bold; color :darksalmon; font-size: 3em; font-family:Verdana, Geneva, Tahoma, sans-serif; margin-bottom: 5px; ">WITH PLAN</h1>
    <div id = containerP1>
        <div id = containerP1_1>
            <h2>Create Account</h2>
            <form action="#" id="signUp" onsubmit="return submit_chk(this)" onreset="return reset_chk(this)">
                <ul id="userInfo">
                    <li>
                        <label for="userInfoId" class="field">ID</label>
                        <input type="text" id="userInfoId" placeholder="5-20 lowercase letters, numbers" required>
                    </li>
                    <li>
                        <label for="userInfoPass1" class="field">Password</label>
                        <input type="text" id="userInfoPass1" placeholder="8-12 characters. A combination of uppercase letters, lowercase letters, numbers, and symbol" required>
                    </li>
                    <li>
                        <label for="userInfoPass2" class="field">Confirm Password</label>
                        <input type="text" id="userInfoPass2" required>
                    </li>
                </ul>
                <ul id="singUpbuttons">
                    <li>
                        <button type="submit" class="btn btnBlack">Sign up</button>					
                    </li>
                    <li>
                        <button type="reset" class="btn btnGray">Cancel</button>
                    </li>
                </ul>
            </form>
        </div>
        <div id = containerP1_2>
            <h2>Sign in</h2>
            <form action="#" id="signIn" onsubmit="return submit_log(this)">
                <ul id="user">
                    <li>
                        <label for="userId" class="field">ID</label>
                        <input type="text" id="userId" required>
                    </li>
                    <li>
                        <label for="userPass" class="field">Password</label>
                        <input type="text" id="userPass" required>
                    </li>
                </ul>

                <ul id="signInbuttons">
                    <li>
                        <button type="submit" class="btn btnBlack">Login</button>					
                    </li>
                </ul>
            </form>
        </div>
    </div>


    <!--PART2-->

    <div id="containerP2" style="display:None">
        <button class="logout">Logout</button>
        <h2>Admin mode</h2>
        
        <p>Account List</p>
        <!--https://baessi.tistory.com/109 테이블 생성 참고-->
        <table id = "accountTable">
            <thead>
                <tr class = "accountColumn">
                    <th>User ID</th>
                    <th>User Password</th>
                    <th>User Start</th>
                    <th>Recent Login</th>
                </tr>
            </thead>
            <tbody class = accountData>
                
            </tbody>
        </table>

        
    </div>

    <!--PART3-->

    <div id="containerP3" style="display:None">        
        <div class="indexList">
            <div class="line">na</div>
            <button>Our Campaign</button>
            <button>Our Goal</button>
            <button>My Page</button>
            <button class="logout">Logout</button>
            <div class="line"></div> 
        </div>
        <!--Our Campagin 부분-->
        <div id="containerP3_1">
            <h1 class="main">Our Campagin</h1>
            <div id="onProject">
                
                <div>
                    <img src="http://greenfund.org/data/board/campaign/file1_1638855039.png" alt="Fail to load Image"/>
                    <h3>Protect the Earth!</h3>
                    <h4 class="donation" >donation : </h4>
                </div>
                <div>
                    <img src="https://www.unhcr.or.kr/ukraine-emergency/static/images/c1_pic1.jpg" alt="Fail to load Image"/>
                    <h3>Help the Ukrainian refugees</h3>
                    <h4 class="donation">donation :</h4>
                </div>
                <div>
                    <img src="http://greenfund.org/data/board/campaign/file1_1651639846.png" alt="Fail to load Image"/>
                    <h3>Help Uljin-Samchuk Forest recover from forest fires</h3>
                    <h4 class="donation">donation :</h4>
                </div>
            </div>
        </div>
        <!--Our Goal 부분-->
        <div id="containerP3_2">
            <h1 class="main">Our Goal</h1>
            <h2>We are here to keep your plans and promises. If you don't keep your promise, I'll collect the donation so that you can fulfill your promise as much as possible.</h2>
        </div>
        <!--My Page 부분(동적으로 생성할필요가있다...)-->
        <div id="containerP3_3">
            <h1 class="main">My Page</h1>
            <button class="add">+ add</button>
            <!--add 버튼 눌렀을 때 뜨는 창 부분-->
            <div class="addFrame">
                
                <h3>Add appointment</h3>

                <div>
                    <p class="addFrameMain">Context</p>
                    <input class="value" type="text" autocomplete="off" > 
                </div>

                <div>
                    <p class="addFrameMain">Time</p>
                    <div id="timeSet">
                        <button class="value">9AM</button>
                        <!--Hour P-->
                        <div class="hourContainer">
                            <p>9AM</p>
                            <p>10AM</p>
                            <p>11AM</p>
                            <p>0PM</p>
                            <p>1PM</p>
                            <p>2PM</p>
                            <p>3PM</p>
                            <p>4PM</p>
                            <p>5PM</p>
                            <p>6PM</p>
                            <p>7PM</p>
                            <p>8PM</p>
                            <p>9PM</p>
                            <p>10PM</p>
                            <p>11PM</p>
                            <p>0AM</p>
                            <p>1AM</p>
                            <p>2AM</p>
                            <p>3AM</p>
                            <p>4AM</p>
                            <p>5AM</p>
                            <p>6AM</p>
                            <p>7AM</p>
                            <p>8AM</p>
                        </div>
                        <button class="value">0minutes</button>
                        <!--minute P-->
                        <div class="minuteContainer">
                            <p>0minutes</p>
                            <p>5minutes</p>
                            <p>10minutes</p>
                            <p>15minutes</p>
                            <p>20minutes</p>
                            <p>25minutes</p>
                            <p>30minutes</p>
                            <p>35minutes</p>
                            <p>40minutes</p>
                            <p>45minutes</p>
                            <p>50minutes</p>
                            <p>55minutes</p>
                        </div>
                        <h3>~</h3>
                        <button class="value">10AM</button>
                         <!--Hour P-->
                        <div class="hourContainer">
                            <p>9AM</p>
                            <p>10AM</p>
                            <p>11AM</p>
                            <p>0PM</p>
                            <p>1PM</p>
                            <p>2PM</p>
                            <p>3PM</p>
                            <p>4PM</p>
                            <p>5PM</p>
                            <p>6PM</p>
                            <p>7PM</p>
                            <p>8PM</p>
                            <p>9PM</p>
                            <p>10PM</p>
                            <p>11PM</p>
                            <p>0AM</p>
                            <p>1AM</p>
                            <p>2AM</p>
                            <p>3AM</p>
                            <p>4AM</p>
                            <p>5AM</p>
                            <p>6AM</p>
                            <p>7AM</p>
                            <p>8AM</p>
                        </div>

                        <button class="value">0minutes</button>
                        <!--minute P-->
                        <div class="minuteContainer">
                            <p>0minutes</p>
                            <p>5minutes</p>
                            <p>10minutes</p>
                            <p>15minutes</p>
                            <p>20minutes</p>
                            <p>25minutes</p>
                            <p>30minutes</p>
                            <p>35minutes</p>
                            <p>40minutes</p>
                            <p>45minutes</p>
                            <p>50minutes</p>
                            <p>55minutes</p>
                        </div>
                    </div>
                </div>
                <div>
                    <button class="addFrameButton save">save</button>
                    <button class="addFrameButton cancel">cancel</button>
                </div>
            </div>

            <!--Table-->
            <!--유저별로 동적으로 생성해야하는 부분(회원가입할때)-->
        <!--
            <table id="MypageTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Content</th>
                        <th>Check</th>
                    </tr>
                </thead>
                
                <tbody>

                </tbody>
            </table>
        -->
        </div>

    </div>    

    

        

        

   
        
    



    
    <script>
        // SignUp 변수
        var $signUpId = $("#userInfoId")
        var $signUpPass1 = $("#userInfoPass1")
        var $singUpPass2 = $("#userInfoPass2")
        var userData = [{'userInfoId' : "admin"}]

        // SignIn 변수
        
        var $signInId = $("#userId")
        var $signInPass = $("#userPass")
        
        //로그아웃 부분
        $(".logout").click(function(){  
            $("#containerP1").css('display', 'block')
            $("#containerP2").css('display', 'none')
            $("#containerP3_1").css('display', 'block')
            $(`#Mypage${$signInId.val()}`).css('display','none') // ab123으로 로그인 한 경우의 마이페이지 테이블을 오프시키는 부분 
            $("#containerP3").css('display', 'none')     
        })

        //ContainerP3 부분
        
            //Our Campagin 부분
        $(".indexList>button:nth-child(2)").click(function(){
            
            $("#containerP1").css('display', 'none')
            $("#containerP2").css('display', 'none')
            $("#containerP3_1").css('display', 'block')
            $("#containerP3_2").css('display', 'none')
            $("#containerP3_3").css('display', 'none')            
        })

            //Our Goal 부분
        $(".indexList>button:nth-child(3)").click(function(){
            $("#containerP1").css('display', 'none')
            $("#containerP2").css('display', 'none')
            $("#containerP3_1").css('display', 'none')
            $("#containerP3_2").css('display', 'block')
            $("#containerP3_3").css('display', 'none')            
        })
            //My page 부분 
        $(".indexList>button:nth-child(4)").click(function(){
            $("#containerP1").css('display', 'none')
            $("#containerP2").css('display', 'none')
            $("#containerP3_1").css('display', 'none')
            $("#containerP3_2").css('display', 'none')
            $("#containerP3_3").css('display', 'block')
            $(`#Mypage${$signInId.val()}`).css('display','')  // ab123이 로그인 했을때 테이블을 다시불러오는 부분          
        })
                //add할시 창 생성 함수 
        $('.add').click(function(){
            $(".addFrame").css('display','block')
            $(".addFrame > h3").text('Add appointment')

            $(".save").off('click').on('click', function(){                       
                result = startEndCollect($(".value"))
                
                now = result[0]
                startString = result[1]
                endString = result[2]
                content = result[3]
                    //행추가
                $(`<tr id="${$signInId.val()}${now}"></tr>`).appendTo($(`#Mypage${$signInId.val()} tbody`))
                    //데이터추가
                $("<td></td>").text(startString).appendTo(`#${$signInId.val()}${now}`)
                $("<td class='endTimeColumn'></td>").text(endString).appendTo(`#${$signInId.val()}${now}`)
                $("<td></td>").text(content).appendTo(`#${$signInId.val()}${now}`)
                $("<td class='check'></td>").appendTo(`#${$signInId.val()}${now}`)
                    //수정 버튼
                $("<button class='modify'></button>").text('m').appendTo(`#${$signInId.val()}${now} .check`)
                    //삭제 버튼
                $("<button class='drop'></button>").text('x').appendTo(`#${$signInId.val()}${now} .check`)
            })   
        })
                    //add로 생성된 창에 시간을 다시 띄우는 부분

                    $("#timeSet>button").each(function(index,element){
                        
                        $(element).click(function(){
                            //시간 label
                            if(index%2 == 0){
                                $(".hourContainer").css('display','none')
                                $(".minuteContainer").css('display','none')
                                var $h = $(".hourContainer").eq(Math.floor(index/2))
                                $h.css('display','block')
                                $h.children().click(function(){
                                    let hour = $(this).text()
                                    $(element).text(hour)
                                    $h.css('display','none')
                                })
                            }
                            //분 label
                            else {
                                $(".hourContainer").css('display','none')
                                $(".minuteContainer").css('display','none')
                                var $m = $(".minuteContainer").eq(Math.floor(index/2))
                                $m.css('display','block')
                                //이부분 어떻게 했는데 잘 이해가 안됨. 그냥 미닛콘테이너>p로 클릭 이벤트 하면 양 미닛이 둘다 변경되버리는 오류가 있었음.  
                                $m.children().click(function(){
                                    let minute = $(this).text()
                                    $(element).text(minute)
                                    $m.css('display','none') 
                                }) 
                            }
                        })
                    })
                    
                                            
                    

                    //cancel 구현

                    $(".cancel").click(function(){
                        $(".addFrame").css('display','none')
                    })
                    
                    //drop 구현 각행을 제거함
                    //정적인 부모요소에 이벤트 해야함.. 동적인 부보면 안되서 document에 이벤트 위임시킴
                    $(document).on('click','.drop',function(){
                        $(this).parent().parent().remove()
                    })
                    

                    //modify 

                    $(document).on('click','.modify',function(){
                        $(".addFrame").css('display','block')
                        $(".addFrame > h3").text('Modify appointment')
                        
                        let tr = $(this).parent().parent()
                        //start, end, content만 선택
                        let startTime,  endTime, content
                        tr.find('td:lt(3)').each(function(index,element){
                            if (index === 0 ){
                                startTime = $(element).text()
                            }
                            else if (index ===1){
                                endTime = $(element).text()
                            }
                            else if (index ===2){
                                content = $(element).text()
                            }
                        })

                        // 0900 -> 9am 0minutes로 바꾸는 과정
                        let startHour = startTime.slice(0,2)
                        let startMinute = startTime.slice(2,)
                        let endHour = endTime.slice(0,2)
                        let endMinute = endTime.slice(2,)

                        startHour = timeToHour(startHour)
                        endHour = timeToHour(endHour)
                        startMinute = timeTominute(startMinute)
                        endMinute = timeTominute(endMinute)

                        // modify appointment에 초기값 할당 
                        $(".addFrame input").val(content)
                        $("#timeSet > .value").each(function(index,element){
                            if (index === 0 ){
                                $(element).text(startHour)
                            } else if (index ===1){
                                 $(element).text(startMinute)
                            } else if (index ===2){
                                 $(element).text(endHour)
                            } else if (index ===3){
                                 $(element).text(endMinute)
                            }    
                        })
                        // save 버튼 누르면 기존 add에 있던 save기능을 제거해야함 row추가 제거할 필요가있음

                        $(".save").off('click').on('click', function(){

                            result = startEndCollect($(".value"))
                            now = result[0]
                            startString = result[1]
                            endString = result[2]
                            content = result[3]
                            //기존 로우에 있는 값 변경
                            
                            tr.find('td:lt(3)').each(function(index,element){
                                if (index===0){
                                    $(element).text(startString)
                                } else if (index===1){
                                    $(element).text(endString)
                                } else if (index===2){
                                    $(element).text(content)               
                                }
                            })
                        })
                    })

                    // endtime으로부터 1분이 지난 경우라면 modify, drop 기능 막아버려야함
                    // 동적으로 생성되기에 간접 선택
                   
                    setInterval(function(){
                        
                        $(".endTimeColumn").each(function(index,element){
                            console.log('1')
                            let endTimeText = $(element).text()
                            let endHour = endTimeText.slice(0,2)
                            let endMinute = endTimeText.slice(2)
        
                            let endTime = new Date()
                            endTime.setHours(endHour,endMinute,0)
        
                            let overTime = endTime
                            
                            overTime.setMinutes(endTime.getMinutes()+1)
                            console.log(overTime)
                            let curTime = new Date()
                            console.log("x")
                            if (curTime >= overTime){
                                $(element).parent().find('td').css('background-color','#df8f8f')
                                $(element).parent().find('button').css('display','none')
                                console.log($(element).find('button'))
                            }
                        })
                    },3000)
                    
                  
                    
                       

        
        
        // save 하기 위해 데이터들을 분리하고 모으는 함수
        function startEndCollect($cl){
            let now = new Date().getTime() // 현재 로그인 id에 할당할 식별자로쓸 것 
            let startString = ''
            let endString = ''
            $cl.each(function(index,element){
                // content
                // time 데이터 수집 
                if (index>=1){
                    //am, minutes을 소문자화
                    let time = $(element).text().toLowerCase()                    
                    //start시간 수집
                    if (index<3) {

                        if (time.includes("am")){
                            if (time.replace("am","")<10){
                                var hour = "0"+time.replace("am","")
                                }
                                else {
                                    var hour = time.replace("am","")
                                }
                            startString = startString + hour
                        }
                        else if (time.includes("pm")){
                            var hour = 12+ parseInt(time.replace("pm",""))
                            hour = hour.toString()
                            startString = startString + hour
                        }

                        if (time.includes("minutes")){
                            var minute = time.replace("minutes","")
                            if (minute<10){
                                minute = "0"+minute
                            }
                            startString = startString + minute
                        }
                        
                    }
                    else if (index>=3){
                        if (time.includes("am")){
                            if (time.replace("am","")<10){
                            var hour = "0"+time.replace("am","")
                            }
                            else {
                                var hour = time.replace("am","")
                            }
                            endString = endString + hour
                        }
                        else if (time.includes("pm")){
                            var hour = 12+ parseInt(time.replace("pm",""))
                            hour = hour.toString()
                            endString = endString + hour
                        }

                        if (time.includes("minutes")){
                            var minute = time.replace("minutes","")
                            if (minute<10){
                                minute = "0"+minute
                            }
                            endString = endString + minute
                        }
                        
                    }
                }              
            })// start, end 수집완료
            
            let content = $(".value:first").val()

            return [now,startString,endString,content]
        }


        function timeToHour(hour){
            //오후인경우
            if (parseInt(hour)>=12){
                hour = (parseInt(hour)-12).toString() +"PM"
            }
            //10시 11시
            else if (parseInt(hour)>=10){
                hour = hour+"AM"
            }
            //0~9시
            else{
                 hour = hour.slice(1)+"AM"
            }
            return hour
        }

        function timeTominute(minute){
            minute = parseInt(minute).toString() +"minutes"
            return minute
        }


        function isUserInfoId(id){
            for(let info of userData){
                if (id === info.userInfoId){
                    return true
                }
            }
            return false
        }

        function isPreserveId(id){
            let reg = /^[a-z0-9]{5,20}$/g
            // 규정이 통과하면
            return reg.test(id)
        }

        function isPreservePass(pass){
            let reg = /^(?=.*?[A-Z])(?=.*[a-z])(?=.*?[0-9])(?=.*?[!@#$%^&*()]).{8,12}$/g
            return reg.test(pass)
        
        }

        function submit_chk(){
            
            if (isUserInfoId($signUpId.val())){
                alert("ID already exist in our records. Please try another one or log in")
                
            }

            else if (!isPreserveId($signUpId.val())){
                alert("Please follow the rules and enter your ID")
            }

            else if (!isPreservePass($signUpPass1.val())){
                alert("Please enter your passward 8-12 characters. A combination of uppercase letters, lowercase letters, numbers, and symbol")
            }

            else if ($signUpPass1.val() !== $singUpPass2.val()){
                alert("The password you entered does not match. Please check again.")
            }

            else if (isPreserveId($signUpId.val())){
                let userStart = new Date()
                let userRecent = null
                userData.push({"userInfoId":$signUpId.val(), "userInfoPass":$signUpPass1.val(), "userStart" : userStart, "userRecent" : null, "donation" : null})
                //tr 추가
                $(`<tr id="${$signUpId.val()}"></tr>`).appendTo(".accountData")
                //tr 밑에 td추가
                //admin 관리 데이터 부분
                $("<td></td>").text($signUpId.val()).appendTo(`#${$signUpId.val()}`)
                $("<td></td>").text($signUpPass1.val()).appendTo(`#${$signUpId.val()}`)
                $("<td></td>").text(userStart).appendTo(`#${$signUpId.val()}`)
                $("<td class='userRecent'></td>").text(userRecent).appendTo(`#${$signUpId.val()}`)

                //mypage부분 

                $(`<table id="Mypage${$signUpId.val()}" ></table>`).appendTo("#containerP3_3")
                //thead, tbody  
                $("<thead></thead>").appendTo($(`#Mypage${$signUpId.val()}`))
                $("<tbody></tbody>").appendTo($(`#Mypage${$signUpId.val()}`))
                //thead row
                $("<th style='text-align: center';>Start Time</th>").appendTo($(`#Mypage${$signUpId.val()} > thead`))
                $("<th style='text-align: center';>End Time</th>").appendTo($(`#Mypage${$signUpId.val()} > thead`))
                $("<th style='text-align: center';>Content</th>").appendTo($(`#Mypage${$signUpId.val()} > thead`))
                $("<th style='text-align: center';>Check</th>").appendTo($(`#Mypage${$signUpId.val()} > thead`))               
               
                alert("success!, ")
            } 
            
            else {
                alert("Error,")
            }
            console.log(userData)
            return false
        }

        function reset_chk(){
            $signUpId.val('')
            $signUpPass1.val('')
            $singUpPass2.val('')
            $signUpId.focus()
            return false
        }

        function submit_log(){
            //Admin 모드는 Part2 보여줌
            if ($signInId.val() === "admin" && $signInPass.val()==="admin"){
                $("#containerP1").css('display', 'None')
                $("#containerP2").css('display','Block')
                
            }
            else{
                // suc는 로그인이 성공되면 1로 스위치
                let suc = 0 
                for (let x of userData){

                    //로그인 성공
                    if($signInId.val()===x.userInfoId && $signInPass.val()===x.userInfoPass){
                        $("#containerP1").css('display', 'None')
                        $("#containerP3").css('display','Block')
                        $("#containerP3_2").css('display', 'none')
                        $("#containerP3_3").css('display', 'none')      

                        //최근 로그인 시간 
                        x.userRecent = new Date()
                        $(`#${x.userInfoId}>.userRecent`).text(x.userRecent)

                        suc = 1
                    }

                }
                //로그인 실패
                if (suc === 0) {
                    alert("Please confirm your ID and Password")
                    $signInId.val('')
                    $signInPass.val('')
                }
                
            }
            return false
        }
        
        
    </script>
    
</body>
</html>